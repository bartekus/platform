name: VM Initialization

on:
  workflow_dispatch:
    inputs:
      droplet_ip:
        description: "Droplet IPv4"
        required: false
      droplet_ipv6:
        description: "Droplet IPv6"
        required: false
      host:
        description: "SSH host (fallback)"
        required: false
      user:
        description: "SSH username"
        required: false

env:
  ROOT_DIRECTORY: /opt

jobs:
  initialize_vm:
    runs-on: ubuntu-latest
    env:
      TARGET_HOST: ${{ github.event.inputs.droplet_ip || github.event.inputs.host || vars.HOST }}
      TARGET_USER: ${{ github.event.inputs.user || vars.USER }}
      TARGET_IPV6: ${{ github.event.inputs.droplet_ipv6 }}

    steps:
      - name: Echo inputs (sanity)
        run: |
          echo "IP4=${{ env.TARGET_HOST }}"
          echo "IP6=${{ env.TARGET_IPV6 }}"
          echo "HOST=${{ env.TARGET_HOST }}"
          echo "USER=${{ env.TARGET_USER }}"
          test -n "${{ env.TARGET_HOST }}" || { echo "âŒ TARGET_HOST is empty"; exit 1; }
          test -n "${{ env.TARGET_USER }}" || { echo "âŒ TARGET_USER is empty"; exit 1; }

      - name: Checkout code
        uses: actions/checkout@v4

      # Everything from here happens ON THE VM over SSH
      - name: Install Docker, Compose v2, docker-rollout on remote (idempotent)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.TARGET_HOST }}
          username: ${{ env.TARGET_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -Eeuo pipefail

            have() { command -v "$1" >/dev/null 2>&1; }

            apt_wait() {
              # Wait for any apt/dpkg/unattended-upgrades activity and locks to clear.
              echo "â³ Waiting for apt/dpkg locks to free (up to 300s)â€¦"
              for i in $(seq 1 300); do
                if ! pgrep -x apt >/dev/null 2>&1 \
                   && ! pgrep -x apt-get >/dev/null 2>&1 \
                   && ! pgrep -x dpkg >/dev/null 2>&1 \
                   && ! pgrep -x unattended-upgrade >/dev/null 2>&1 \
                   && [ ! -e /var/lib/apt/lists/lock ] \
                   && [ ! -e /var/lib/dpkg/lock-frontend ] \
                   && [ ! -e /var/lib/dpkg/lock ]; then
                  echo "âœ… Apt locks are free."
                  return 0
                fi
                sleep 1
              done
              echo "âš ï¸  Apt locks still present; showing diagnostics:"
              ps aux | egrep 'apt|dpkg|unattended' || true
              ls -l /var/lib/apt/lists/lock /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock 2>/dev/null || true
              return 1
            }

            apt_safe() {
              # Run apt-get with retries and lock waiting.
              local cmd="$*"
              apt_wait
              # Stop apt-daily timers to avoid races during our install window (best-effort).
              if command -v systemctl >/dev/null 2>&1; then
                sudo systemctl stop apt-daily.timer apt-daily-upgrade.timer 2>/dev/null || true
              fi
              for attempt in 1 2 3; do
                echo "ğŸ”§ apt attempt ${attempt}: $cmd"
                if sudo DEBIAN_FRONTEND=noninteractive bash -c "$cmd"; then
                  return 0
                fi
                echo "â€¦retrying in 5s"
                sleep 5
                apt_wait || true
              done
              echo "âŒ apt failed after retries: $cmd"
              return 1
            }

            echo "ğŸ” Detecting distroâ€¦"
            if [ -f /etc/os-release ]; then . /etc/os-release; DISTRO="${ID:-unknown}"; else DISTRO="unknown"; fi
            echo "Distro: $DISTRO"

            echo "ğŸ”§ Ensuring curl, ca-certificates"
            if have apt-get; then
              apt_safe "apt-get update -y"
              apt_safe "apt-get install -y curl ca-certificates"
            elif have dnf; then
              sudo dnf install -y curl ca-certificates
            elif have yum; then
              sudo yum install -y curl ca-certificates
            fi

            echo "ğŸ³ Installing Docker Engine (idempotent)"
            if have docker; then
              echo "âœ… Docker present: $(docker --version)"
            else
              # Official convenience script handles repo setup & engine install (Debian/Ubuntu)
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              echo "âœ… Docker installed: $(docker --version)"
            fi

            echo "ğŸ”§ Enabling & starting docker service if systemd available"
            if command -v systemctl >/dev/null 2>&1; then
              sudo systemctl enable docker || true
              sudo systemctl restart docker || sudo systemctl start docker || true
              sudo systemctl --no-pager -l status docker | sed -n '1,8p' || true
            else
              # SysV / other init fallbacks
              if command -v service >/dev/null 2>&1; then
                sudo service docker restart || sudo service docker start || true
              elif [ -x /etc/init.d/docker ]; then
                sudo /etc/init.d/docker restart || sudo /etc/init.d/docker start || true
              else
                echo "âš ï¸  Could not control docker service (no systemctl/service/init.d). Continuing."
              fi
            fi

            echo "ğŸ§© Ensuring docker 'compose' plugin (v2)"
            if docker compose version >/dev/null 2>&1; then
              echo "âœ… docker compose present: $(docker compose version)"
            else
              if have apt-get; then
                apt_safe "apt-get update -y"
                # docker-compose-plugin provides `docker compose`
                apt_safe "apt-get install -y docker-compose-plugin"
              fi
              if ! docker compose version >/dev/null 2>&1; then
                echo "âš ï¸  docker compose plugin not found via package manager; installing static binary"
                VER="v2.29.7"
                sudo mkdir -p /usr/local/lib/docker/cli-plugins
                sudo curl -fsSL "https://github.com/docker/compose/releases/download/${VER}/docker-compose-$(uname -s)-$(uname -m)" \
                  -o /usr/local/lib/docker/cli-plugins/docker-compose
                sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              fi
              docker compose version
            fi

            echo "ğŸ”Œ Ensuring docker-rollout CLI plugin"
            PLUGDIR="${HOME}/.docker/cli-plugins"
            PLUGPATH="${PLUGDIR}/docker-rollout"
            mkdir -p "$PLUGDIR"
            if docker rollout --help >/dev/null 2>&1; then
              echo "âœ… docker-rollout already available"
            else
              RVER="v0.13"
              if curl -fsSL "https://raw.githubusercontent.com/wowu/docker-rollout/${RVER}/docker-rollout" -o "$PLUGPATH"; then
                echo "docker-rollout pinned ${RVER}"
              else
                echo "fallback to main"
                curl -fsSL "https://raw.githubusercontent.com/wowu/docker-rollout/main/docker-rollout" -o "$PLUGPATH"
              fi
              chmod +x "$PLUGPATH"
              docker rollout --help >/dev/null
              echo "âœ… docker-rollout installed at ${PLUGPATH}"
            fi

            echo "ğŸ‘¥ Ensuring 'docker' group exists"
            if getent group docker >/dev/null 2>&1; then
              echo "âœ… group 'docker' exists"
            else
              sudo groupadd docker
              echo "â• created group 'docker'"
            fi

            echo "ğŸ‘¤ Managing user membership in 'docker' group"
            CURRENT_USER="$(id -un)"
            # If you connected as root, there's no need to add root to docker group.
            if [ "$CURRENT_USER" != "root" ]; then
              if id -nG "$CURRENT_USER" | tr ' ' '\n' | grep -qx docker; then
                echo "âœ… $CURRENT_USER already in docker group"
              else
                sudo usermod -aG docker "$CURRENT_USER"
                echo "â• Added $CURRENT_USER to docker group (re-login required for new shell sessions)."
              fi
            else
              echo "â„¹ï¸  Running as root; skipping docker group membership."
            fi

            echo "ğŸ” Docker info summary:"
            docker info --format '{{.ServerVersion}} (Driver: {{.Driver}}), Root: {{.DockerRootDir}}' || true

      - name: Validate Docker and Docker Compose on remote
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.TARGET_HOST }}
          username: ${{ env.TARGET_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -Eeuo pipefail
            command -v docker >/dev/null 2>&1 || { echo "âŒ docker missing"; exit 1; }
            command -v docker >/dev/null 2>&1 && docker --version
            docker compose version || { echo 'âŒ docker compose missing'; exit 1; }
            echo "âœ… Docker & Compose are ready on $(hostname)"
            # Confirm service is running when systemd is present
            if command -v systemctl >/dev/null 2>&1; then
              systemctl is-active --quiet docker && echo "âœ… docker service is active" || (echo "âŒ docker service not active"; systemctl --no-pager -l status docker; exit 1)
            fi
            echo "Server is ready to use ğŸ‰"